---
title: "MiniProyecto"
author: "Sergio Marín Castro // Laura Isabel Montoliu Peris // Beatriz Perello Osborne // Gonzalo Sanchez Muñoz"
date: "11/4/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# cargamos las librerías necesarias

library(readr)
library(dplyr)
library(tidyr)
library(stringr)
library(lubridate)
library(ggplot2)
library(paletteer)
library(plotly)

```

Paso 3

Descargamos los ficheros de datos y los almacenamos en una carpeta, llamada 'data'.


SIGNIFICADO DE LAS VARIABLES

recvTime : Fecha en la que se inserto el dato en la plataforma
FiwareServicePath : Servicio al que pertenece el sensor
EntityType : Tipo de sensor
EntityId : Identificador único del sensor
LAeq : En este caso el período establecida para este sensor es de 1 minuto
LAeq_d: Es un indicador de ruido durante el dia desde las 7 hasta las 19 horas.(12h)
LAeq_den: Indice de ruido día-tarde-noche, para determinar la molestia vinculada a la exposición al ruido.
LAeq_e: Es un indicador del nivel sonoro durante la tarde desde las 19 hasta las 23 horas.(4h)
LAeq_n: Es un indicador del nivel sonoro durante la noche desde las 23 hasta las 7 horas.(8h)
Dateobserved: Día al que se refieren las medidas.

Paso 4

Este paso consiste en importar y fusionar todos los datos en un solo dataframe ("RUZAFA"), además debemos realizar una exploración inicial de los datos.

Para ello, vamos a importar todos los ficheros de datos descargados anteriormente, creando una variable con el dataframe de dichos ficheros.

```{r}
# Importamos ficheros en data frames
VivChafCadz <- read_csv("data/ VivonsChaflánCádiz.csv", show_col_types = FALSE)
Cadiz3 <- read_csv("data/Cadiz3.csv", show_col_types = FALSE)
Cadiz16 <- read_csv("data/Cadiz16.csv", show_col_types = FALSE)
CarlCerv34 <- read_csv("data/CarlesCervera34.csv", show_col_types = FALSE)
CarlCervChaf <- read_csv("data/CarlesCervera Chaflán.csv", show_col_types = FALSE)
Cuba3 <- read_csv("data/Cuba3.csv", show_col_types = FALSE)
DoctorSerrano21 <- read_csv("data/DoctorSerrano21.csv", show_col_types = FALSE)
GeneralPrim <- read_csv("data/GeneralPrim.csv", show_col_types = FALSE)
PuertoRico21 <- read_csv("data/PuertoRico21.csv", show_col_types = FALSE)
SalvAbrilChaf <- read_csv("data/SalvadorAbrilChaflán.csv", show_col_types = FALSE)
Sueca2 <- read_csv("data/Sueca2.csv", show_col_types = FALSE)
Sueca32 <- read_csv("data/Sueca32.csv", show_col_types = FALSE)
Sueca61 <- read_csv("data/Sueca61.csv", show_col_types = FALSE)
SuecaEsqDenia <- read_csv("data/SuecaEsqDenia.csv", show_col_types = FALSE)
```

Para una clara exploración debemos unir los dataframes, creando así uno más grande con toda la información, en este caso 'RUZAFA'.

```{r}
# unimos los data frames
RUZAFA <- VivChafCadz %>% 
  full_join(Cadiz3) %>%
  full_join(Cadiz16) %>%
  full_join(CarlCervChaf) %>% 
  full_join(CarlCerv34) %>% 
  full_join(Cuba3) %>% 
  full_join(DoctorSerrano21) %>% 
  full_join(GeneralPrim)  %>% 
  full_join(PuertoRico21) %>% 
  full_join(SalvAbrilChaf)%>% 
  full_join(Sueca2 )%>% 
  full_join(Sueca32) %>% 
  full_join(Sueca61) %>% 
  full_join(SuecaEsqDenia)

View(RUZAFA)

```

Vamos a realizar la primera exploración inicial. 
Para ello vamos a ver sus dimensiones, nombres de variables, mayor y menor fecha observada...

```{r}
#Exploraion inicial

dim(RUZAFA)
names(RUZAFA)

attach(RUZAFA)

max(dateObserved)
min(dateObserved)

table(entityType)
table(fiwareServicePath)
table(entityId)

detach(RUZAFA)

```

Mediante estas funciones hemos observado varias cosas a destacar sobre la información:

DIMENSIONES RUZAFA -->
   - Columnas = 11
   - Filas = 6450
   
NOMBRES VARIABLES DE RUZAFA : 
(id, recvTime,fiwareServicePath,entityType,entityI,LAeq,LAeq_d,LAeq_den,LAeq_e,LAeq_n,
dateObserved)

MAXIMA FECHA OBSERVADA: 2022-04-10
MINIMA FECHA OBSERVADA: 2020-09-17

DATOS DISPONIBLES DE CADA CALLE -->

T248652-daily: 469
T248655-daily: 476
T248661-daily: 483
T248669-daily: 488
T248670-daily: 464 
T248671-daily: 475
T248672-daily: 465
T248676-daily: 460 
T248677-daily: 476 
T248678-daily: 487 
T248680-daily: 454 
T248682-daily: 447
T248683-daily: 327
T248684-daily: 479 

DISTINTOS TIPOS DE SENSOR : 1
DISTINTOS TIPOS DE SERVIVIOS A LOS QUE PERTENECEN LOS SENSORES: 1


```{r}
#Analizamos si los años estan compeltos o a alguno le falta algun dato
RUZAFA%>%
  group_by(Año = year(dateObserved))%>%
  summarise(min= min(dateObserved) ,max = max(dateObserved))
```

Vemos que el año 2021 esta completo, es decir, la última fecha en la que se ha recogido información es el último día del año. Mientras que en 2020 empezamos a recolectar los datos desde Septiembre y en 2022 no tenemos más datos a partir de abril.

```{r}
#Hacemos una tabla con el resumen de las variables numericas
RUZAFA1= pivot_wider(RUZAFA)
RUZAFA1 = RUZAFA1 %>% select(starts_with("LA"))

summary = summary(RUZAFA1)
SUMMARY = data.frame(summary)
SUMMARY = SUMMARY %>% separate(Freq, into = c("Medida", "Valor"), sep= ":")
SUMMARY = pivot_wider(SUMMARY, names_from = Medida, values_from = Valor)
SUMMARY = SUMMARY %>% select(-Var1) 
SUMMARY
```

LLama la atencion que en algunos valores pone "Inf", esto es debido a que como aun no hemos "limpiado" nuestros datos, hay valores incorrectos que deben de ser sustituidos.

Con los datos que tenemos parece ser que el menor nivel sonoro registrado fue por la noche y el mayor durante el dia,tarde y noche. Y haciendo las medias de cada nivel sonoro parece que los mayores niveles los ha registrado el sensor de dia, tarde, noche, pero no podemos estar seguros hasta que no limpiemos nuestros datos.



```{r}
#Realizamos un gráfico para ver de manera más visual la información sobre los
#días de estudio y las calles

ggplot(RUZAFA, aes(entityId, fill =factor(year(dateObserved)))) + 
geom_bar() + 
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
labs(x="Calles",y = "dias", title="Dias de estudio por calle") +
guides(fill = guide_legend(title = "Años"))

```
Por último, gracias al gráfico vemos que en una calle de las registradas no hay información sobre el año 2022. Y que no todas als calles tienen el minmo numero de datos para el año 2020 y 2021, sin embargo para 2022 si.

- PREGUNTAS:
HILO DE LA PRESENTACION-->
Un señor que no esta seguro si comprarse una casa en Ruzafa y que tampoco sabe cuál sería la mejor calle para vivir, nos ha planteado las siguientes preguntas:

1.¿Cuál es la calle que más ha molestado a los vecinos en en los tres últimos años?¿Y la que menos?(Laura).
2.¿Qué calle ha incrementado más el ruido a lo largo del año 2022?. (Laura)
3.¿La sonoridad en Ruzafa ha ido aumentado o disminuyendo a lo largo del tiempo?.
4.¿El covid afectó en algo? ¿Y las fallas? ¿Y la Navidad?.
5.¿Que calles han sido las más ruidosas durante el día, la tarde, y la noche? ¿Y las que menos?.
6.¿Cuál es la calle que más MOLESTÓ a los vecinos sin contar los meses de verano? ¿Y la que menos?.
7.¿En que mes ha habido más acumulación de ruido en Ruzafa en cada año?.
8.¿Que calles son las más tranquilas para vivir en cada estacion de año?.
9.¿En que calle hay más ruido los fines de semana en 2022? ¿Hay alguna relación con la más ruidosa por la noche?.
10.¿En que día de la semana ha habido más ruido por calle?¿Y en general?.
11. Hay que hacer analisis univariante y bivariante
12. Analizar los datos faltantes

RESPUESTA:
En conclusion la calle que le recomendamos mas para vivir es: .... y la que menos es: .....

# Paso 5

Para obtener un tidy dataset, es decir, un dataframe más representativo y claro, vamos a modificar los nombres de las columnas por unos más adecuados.

Además de modificar los nombres de las columnas vamos a realizar ciertas operaciones para dejar un tidy dataset, como por ejemplo, eliminar las columnas que no son de utilidad, asegurarnos de que hay 1 única variable por columna, eliminar o sustituir datos faltantes o datos incorrectos...

Primero comenzamos modificando el nomrbe de las columnas, mirando los nomrbes que tiene nuestro dataframe.
```{r}
colnames(RUZAFA) # miramos los nombres que tiene el dataframe
colnames(RUZAFA) <- c("Id", "Fecha_Registro", "Servicio_Sensor", "Tipo_Entidad_Sensor", "Id_Sensor",
                      "Nivel_Sonoro_Continuo", "Nivel_Sonoro_Dia", "Nivel_Sonoro_dtn", # dtn - día, tarde y noche
                      "Nivel_Sonoro_Tarde", "Nivel_Sonoro_Noche", "Dia_Medicion", "Nombre_Calle")
```

A continuación eliminaremos las columnas que no nos interesen. En este caso los niveles sonoros están en varias columnas pero para que sea un conjunto tidy debe de haber una variable por cada columna.
```{r}
RUZAFA1 <- RUZAFA %>% select(-Servicio_Sensor, -Tipo_Entidad_Sensor)
RUZAFA_TIDY2 <- RUZAFA1 %>% gather(Nivel_Sonoro, Valores, 4:8)
```

Observamos si hay si hay datos faltantes o incorrectos para sustituirlos. Como hemos visto, hay dos valores "Inf" que los sustituiremos por los valores más frecuentes(media).
```{r}
breaks <- c(min(RUZAFA_TIDY2$Valores), 0, 5, max(RUZAFA_TIDY2$Valores))
ggplot(RUZAFA_TIDY2, aes(Valores)) + geom_histogram(bins=30)
RUZAFA_TIDY2 %>% count(Valores)
RUZAFA_TIDY2 %>% filter(Valores != "Inf") %>% summarise(Media = mean(Valores))#Media 60.4
RUZAFA_TIDY <- RUZAFA_TIDY2 %>% mutate(Valores = ifelse(Valores ==  "Inf", 60.4, Valores)) %>% mutate(Nivel_Sonoro = as.factor(Nivel_Sonoro)) #y convertimos la columna Nivel_Sonoro en factores .
View(RUZAFA_TIDY)
```

Por último separamos la columna Fecha Registro, ya que tiene dos variables una de fecha y otra de tiempo.
```{r}
RUZAFA_TIDY = RUZAFA_TIDY %>%
              separate(Fecha_Registro, into=c("Fecha_Registro","Hora_Registro"), sep=10) %>% mutate(Fecha_Registro = as.Date(Fecha_Registro))
str(RUZAFA_TIDY)
```

Aunque no es tidy, también añadimos la columna calles para que sea más fácil de entender los resultados. Entonces, seleccionamos la columna de Id_sensor.
```{r}
Id_Sensor = RUZAFA_TIDY %>% select(Id_Sensor)
```

El siguiente paso será crear una columna para las Calles e introducirla en nuestro dataframe.
```{r}
RUZAFA_TIDY = RUZAFA_TIDY %>%  
  mutate(Id_Sensor = ifelse(Id_Sensor == "T248655-daily", "Cadiz3 ", Id_Sensor))%>% 
  mutate(Id_Sensor = ifelse(Id_Sensor == "T248677-daily" , "VivChafCadz", Id_Sensor))%>% 
  mutate(Id_Sensor = ifelse(Id_Sensor == "T248671-daily" , " Cadiz16 ", Id_Sensor))%>%
  mutate(Id_Sensor = ifelse(Id_Sensor == "T248670-daily" , "CarlCervChaf", Id_Sensor))%>% 
  mutate(Id_Sensor = ifelse(Id_Sensor == "T248678-daily" , "CarlCerv34 ", Id_Sensor)) %>% 
  mutate(Id_Sensor = ifelse(Id_Sensor == "T248682-daily" , "Cuba3", Id_Sensor)) %>% 
  mutate(Id_Sensor = ifelse(Id_Sensor == "T248669-daily" , "DoctorSerrano21", Id_Sensor))%>% 
  mutate(Id_Sensor = ifelse(Id_Sensor == "T248682-daily" , "Cuba3", Id_Sensor)) %>% 
  mutate(Id_Sensor = ifelse(Id_Sensor == "T248672-daily" , "PuertoRico21", Id_Sensor))%>% 
  mutate(Id_Sensor = ifelse(Id_Sensor == "T248676-daily" , "SalvAbrilChaf", Id_Sensor))%>% 
  mutate(Id_Sensor = ifelse(Id_Sensor == "T248683-daily", "Sueca2" , Id_Sensor))%>% 
  mutate(Id_Sensor = ifelse(Id_Sensor == "T248680-daily" , "Sueca32", Id_Sensor))%>% 
  mutate(Id_Sensor = ifelse(Id_Sensor == "T248684-daily","Sueca61", Id_Sensor))%>%
  mutate(Id_Sensor = ifelse(Id_Sensor == "T248652-daily","SuecaEsqDenia",  Id_Sensor))%>% 
  mutate(Id_Sensor = ifelse(Id_Sensor == "T248661-daily" , "GeneralPrim",  Id_Sensor))  

colnames(RUZAFA_TIDY) <- c("Id", "Fecha_Registro", "Hora_Registro", "Calles", "Dia_Medicion", "Nivel_Sonoro", "Valores")
```

Unimos el dataframe con las calles y con Id_Sensores.
```{r}
RUZAFA_TIDY = cbind(RUZAFA_TIDY, Id_Sensor)
```

Y por último, ordenamos de nuevo las columnas.
```{r}
RUZAFA_TIDY = RUZAFA_TIDY [ , c(1,8,2,3,4,6,7,5)]
```


# Paso 6

PREGUNTA 1

¿Cual es la calle que mas ha molestado a los vecinos en en los tres ultimos años?¿Y la que menos?

· *LA QUE MÁS:*

Primero de todo, seleccionamos la calle con mas ruido de cada año:
```{r}
Año2020 = RUZAFA_TIDY %>% group_by(Calles) %>% filter(year(Dia_Medicion) == "2020") %>% summarise(MaxRuido = mean(Valores)) %>% filter(MaxRuido == max(MaxRuido))

Año2021 = RUZAFA_TIDY %>% group_by(Calles) %>% filter(year(Dia_Medicion) == "2021") %>% summarise(MaxRuido = mean(Valores)) %>% filter(MaxRuido == max(MaxRuido))

Año2022 =  RUZAFA_TIDY %>% group_by(Calles) %>% filter(year(Dia_Medicion) == "2022") %>% summarise(MaxRuido = mean(Valores)) %>% filter(MaxRuido == max(MaxRuido))
```

Los unimos y creamos un nuevo data frame para luego añadirle la columna de años convertida en Factor.
```{r}
MaxMolestia = rbind(Año2020, Año2021, Año2022)

MaxMolestia = MaxMolestia %>% mutate(Año = c(2020, 2021, 2022)) %>% mutate(Año = as.factor(Año))
MaxMolestia
```

Por último representamos con una gráfica las calles que mas han molestado a los vecinos en los ultimos 3 años.
```{r}
a =ggplot(MaxMolestia, aes(Año, MaxRuido, color = Calles, size = MaxRuido)) + geom_point(shape = 3, size=5) + ggtitle("Calles con mayor nivel de ruido de media por año")+scale_y_continuous(limits = c(53,67),name = "Nivel de ruido") 
a
```

Como podemos ver, la calle que más ha molestado a los vecinos en 2020, 2021 y 2022 es la misma, Cádiz3.

· *LA QUE MENOS:*

Seguimos los mismos pasos que en el anterior.
```{r}
Año2020 = RUZAFA_TIDY%>% group_by(Calles) %>% filter(year(Dia_Medicion) == "2020") %>% summarise(MinRuido = mean(Valores)) %>% filter(MinRuido == min(MinRuido))

Año2021 = RUZAFA_TIDY%>% group_by(Calles) %>% filter(year(Dia_Medicion) == "2021") %>% summarise(MinRuido = mean(Valores)) %>% filter(MinRuido == min(MinRuido))

Año2022 =  RUZAFA_TIDY%>% group_by(Calles) %>% filter(year(Dia_Medicion) == "2022") %>% summarise(MinRuido = mean(Valores)) %>% filter(MinRuido == min(MinRuido))

#Los unimos y creamos un nuevo data frame
MinMolestia = rbind(Año2020, Año2021, Año2022)
#Añadimos la columna de años y lo convertimos en factor
MinMolestia = MinMolestia %>% mutate(Año = c(2020, 2021, 2022)) %>% mutate(Año = as.factor(Año))

#Por último representamos las calles que menos han molestado a los vecinos en los últimos 3 años
b =ggplot(MinMolestia, aes(Año, MinRuido, color = Calles, size=MinRuido)) + geom_point(shape = 10, size = 5)+ ggtitle("Calles con menor nivel de ruido de media por año")+scale_y_continuous(limits = c(53,67),name = "Nivel de ruido") 
b
```

En este caso,  podemos ver que la calle que menos ha molestado a los vecinos en 2020, 2021 y 2022 es la misma, GeneralPrim.


PREGUNTA 2

¿Qué calle ha incrementado mas el ruido a lo largo del año 2022?

```{r}
RUZAFA_TIDY2 = RUZAFA_TIDY %>% filter(year(Dia_Medicion) == "2022") %>% group_by(Calles)
RUZAFA_TIDY2 = RUZAFA_TIDY2%>%
              select(Calles, Valores, Dia_Medicion)
ggplot(RUZAFA_TIDY2, aes(Dia_Medicion, Valores)) + geom_line() + facet_wrap(~Calles)+geom_smooth(method = 'lm')

```

Se puede ver que el nivel sonoro de cada calle a lo largo de 2022 (enero-marzo) no varía notablemente excepto en el mes de marzo que en todas las calles el nivel aumenta.


PREGUNTA 3

¿La sonoridad en Ruzafa ha ido aumentado o disminuyendo a lo largo del tiempo?¿El covid afectó en algo? ¿Y las fallas? ¿Y la Navidad?

```{r}
RUZAFA_TIDY3_1 = RUZAFA_TIDY %>% select(Dia_Medicion, Calles, Valores) %>% group_by(year(Dia_Medicion)) %>% filter(year(Dia_Medicion) == "2020")
ggplot(RUZAFA_TIDY3_1, aes(Dia_Medicion, Valores, color = month(Dia_Medicion)))+ geom_line() + geom_smooth(color="darkgrey")

RUZAFA_TIDY3_2 = RUZAFA_TIDY %>% select(Dia_Medicion, Calles, Valores) %>% group_by(year(Dia_Medicion)) %>% filter(year(Dia_Medicion) == "2021")
ggplot(RUZAFA_TIDY3_2, aes(Dia_Medicion, Valores, color = month(Dia_Medicion)))+ geom_line() + scale_y_continuous(limits=c(40,100)) + geom_smooth(color="darkgrey")

RUZAFA_TIDY3_3 = RUZAFA_TIDY %>% select(Dia_Medicion, Calles, Valores) %>% group_by(year(Dia_Medicion)) %>% filter(year(Dia_Medicion) == "2022")

ggplot(RUZAFA_TIDY3_3, aes(Dia_Medicion, Valores, color = month(Dia_Medicion)))+ geom_line() + scale_y_continuous(limits=c(40,100)) + geom_smooth(color="darkgrey")
```

Ahora organizamos el ruido que ha habido por la noche en cada una de las calles y lo mostramos en un gráfico.

Posteriormente, debemos relacionar el máximo ruido que hubo con la máxima noche de ruido.

```{r}
dat = RUZAFA_TIDY %>% filter(Nivel_Sonoro == "Nivel_Sonoro_Noche") 

#COLS = c("gray", "pink", "blue", "#5CB85C", "yellow", "orange", "purple", "black", "turquese", "brown", "green", "red", )
ggplot(dat, aes(x = Dia_Medicion, y = Valores, color = Calles)) + geom_line(position = "jitter") + scale_color_discrete(labels = c("Calle 1", "Calle 2",  "Calle 3",  "Calle 4",  "Calle 5",  "Calle 6",  "Calle 7",  "Calle 8",  "Calle 9",  "Calle 10",  "Calle 11",  "Calle 12",  "Calle 13",  "Calle 14" )) + facet_wrap(~Calles)

ggplot(dat, aes(x = Dia_Medicion, y = Valores, color = Calles)) + geom_line(position = "jitter") + scale_color_discrete(labels = c("Calle 1", "Calle 2",  "Calle 3",  "Calle 4",  "Calle 5",  "Calle 6",  "Calle 7",  "Calle 8",  "Calle 9",  "Calle 10",  "Calle 11",  "Calle 12",  "Calle 13",  "Calle 14" )) 

dat= dat%>%group_by(Calles, Mes = month(Dia_Medicion)) %>% summarise(Max = max(Valores)) %>% mutate(Mes = ifelse(Mes == 1, "enero",Mes)) %>% mutate(Mes = ifelse(Mes == 2, "febrero",Mes)) %>% mutate(Mes = ifelse(Mes == 3, "marzo",Mes)) %>% mutate(Mes = ifelse(Mes == 4, "abril",Mes)) %>% mutate(Mes = ifelse(Mes == 5, "mayo",Mes)) %>% mutate(Mes = ifelse(Mes == 6, "junio",Mes)) %>% mutate(Mes = ifelse(Mes == 7, "julio",Mes)) %>% mutate(Mes = ifelse(Mes == 8, "agosto",Mes)) %>% mutate(Mes = ifelse(Mes == 9, "septiembre",Mes)) %>% mutate(Mes = ifelse(Mes == 10, "octubre",Mes)) %>% mutate(Mes = ifelse(Mes == 11, "noviembre",Mes)) %>% mutate(Mes = ifelse(Mes == 12, "diciembre",Mes))
dat
```


PREGUNTA 4

¿Qué calles han sido las más ruidosas durante el día, la tarde, y la noche? ¿Y las que menos?

```{r}

```

PREGUNTA 5

¿Suele haber más silencio por la tarde o durante el día en Ruzafa?

```{r}

```

PREGUNTA 6

¿Cuál es la calle que más MOLESTÓ a los vecinos sin contar los meses de verano? ¿Y la que menos?

Para este caso vamos a suponer los meses de verano como: Junio, Julio y Agosto.
Pero primero creamos variables de todos los meses del año en los que se ha guardado información, para así poder usar la información de forma más sencilla.

· *MÁS MOLESTIA:*

En primer lugar, seleccionamos la calle con mas ruido de cada mes, exceptuando los meses de verano que suponemos que son Junio, Julio y Agosto.
```{r}
ENERO = RUZAFA_TIDY %>% group_by(Calles) %>% filter(month(Dia_Medicion) == "1") %>% summarise(MaxRuido = mean(Valores)) %>% filter(MaxRuido == max(MaxRuido))

FEBRERO = RUZAFA_TIDY %>% group_by(Calles) %>% filter(month(Dia_Medicion) == "2") %>% summarise(MaxRuido = mean(Valores)) %>% filter(MaxRuido == max(MaxRuido))

MARZO = RUZAFA_TIDY %>% group_by(Calles) %>% filter(month(Dia_Medicion) == "3") %>% summarise(MaxRuido = mean(Valores)) %>% filter(MaxRuido == max(MaxRuido))

ABRIL = RUZAFA_TIDY %>% group_by(Calles) %>% filter(month(Dia_Medicion) == "4") %>% summarise(MaxRuido = mean(Valores)) %>% filter(MaxRuido == max(MaxRuido))

MAYO = RUZAFA_TIDY %>% group_by(Calles) %>% filter(month(Dia_Medicion) == "5") %>% summarise(MaxRuido = mean(Valores)) %>% filter(MaxRuido == max(MaxRuido))

SEPTIEMBRE = RUZAFA_TIDY %>% group_by(Calles) %>% filter(month(Dia_Medicion) == "9") %>% summarise(MaxRuido = mean(Valores)) %>% filter(MaxRuido == max(MaxRuido))

OCTUBRE = RUZAFA_TIDY %>% group_by(Calles) %>% filter(month(Dia_Medicion) == "10") %>% summarise(MaxRuido = mean(Valores)) %>% filter(MaxRuido == max(MaxRuido))

NOVIEMBRE = RUZAFA_TIDY %>% group_by(Calles) %>% filter(month(Dia_Medicion) == "11") %>% summarise(MaxRuido = mean(Valores)) %>% filter(MaxRuido == max(MaxRuido))

DICIEMBRE = RUZAFA_TIDY %>% group_by(Calles) %>% filter(month(Dia_Medicion) == "12") %>% summarise(MaxRuido = mean(Valores)) %>% filter(MaxRuido == max(MaxRuido))
```

Luego, los unimos y creamos un nuevo data frame para luego añadirle la columna de años convertida en Factor y añadimos la columna meses como factor.
```{r}
MaxMolNoVe = rbind(ENERO,FEBRERO,MARZO,ABRIL,MAYO,SEPTIEMBRE,OCTUBRE,NOVIEMBRE,DICIEMBRE)
MaxMolNoVe = MaxMolNoVe %>% mutate(Mes = c("ENERO","FEBRERO","MARZO","ABRIL","MAYO","SEPTIEMBRE","OCTUBRE","NOVIEMBRE","DICIEMBRE")) %>% mutate(Mes= as.factor(Mes))
```

Y ya, por último representamos las calles que mas han molestado a los vecinos en general exceptuando los meses de verano.
```{r}
maxnove =ggplot(MaxMolNoVe, aes(Mes, MaxRuido, color = Calles, size=MaxRuido)) + geom_point(shape = 8, size = 4,)+ ggtitle("Calles con mayor nivel de ruido de media por mes sin verano")+scale_y_continuous(limits = c(45,85),name = "Nivel de ruido") 
maxnove
```

Observando la gráfica, podemos ver que la calle que más ha molestado a los vecinos en la mayoría de meses es Cádiz3 excepto en Marzo que fue la de Sueca32.

· *MENOS MOLESTIA:*

Realizamos los mismos pasos que en el apartado anterior, esta vez mirando los datos mínimos.
```{r}
ENERO2 = RUZAFA_TIDY %>% group_by(Calles) %>% filter(month(Dia_Medicion) == "1") %>% summarise(MinRuido = mean(Valores)) %>% filter(MinRuido == min(MinRuido))

FEBRERO2 = RUZAFA_TIDY %>% group_by(Calles) %>% filter(month(Dia_Medicion) == "2") %>% summarise(MinRuido = mean(Valores)) %>% filter(MinRuido == min(MinRuido))

MARZO2 = RUZAFA_TIDY %>% group_by(Calles) %>% filter(month(Dia_Medicion) == "3") %>% summarise(MinRuido = mean(Valores)) %>% filter(MinRuido == min(MinRuido))

ABRIL2 = RUZAFA_TIDY %>% group_by(Calles) %>% filter(month(Dia_Medicion) == "4") %>% summarise(MinRuido = mean(Valores)) %>% filter(MinRuido == min(MinRuido))

MAYO2 = RUZAFA_TIDY %>% group_by(Calles) %>% filter(month(Dia_Medicion) == "5") %>% summarise(MinRuido = mean(Valores)) %>% filter(MinRuido == min(MinRuido))

SEPTIEMBRE2 = RUZAFA_TIDY %>% group_by(Calles) %>% filter(month(Dia_Medicion) == "9") %>% summarise(MinRuido = mean(Valores)) %>% filter(MinRuido == min(MinRuido))

OCTUBRE2 = RUZAFA_TIDY %>% group_by(Calles) %>% filter(month(Dia_Medicion) == "10") %>% summarise(MinRuido = mean(Valores)) %>% filter(MinRuido == min(MinRuido))

NOVIEMBRE2 = RUZAFA_TIDY %>% group_by(Calles) %>% filter(month(Dia_Medicion) == "11") %>% summarise(MinRuido = mean(Valores)) %>% filter(MinRuido == min(MinRuido))

DICIEMBRE2 = RUZAFA_TIDY %>% group_by(Calles) %>% filter(month(Dia_Medicion) == "12") %>% summarise(MinRuido = mean(Valores)) %>% filter(MinRuido == min(MinRuido))

#Los unimos y creamos un nuevo data frame
MinMolNoVe = rbind(ENERO2,FEBRERO2,MARZO2,ABRIL2,MAYO2,SEPTIEMBRE2,OCTUBRE2,NOVIEMBRE2,DICIEMBRE2)
#Añadimos la columna de meses y lo convertimos en factor
MinMolNoVe = MinMolNoVe %>% mutate(Mes = c("ENERO","FEBRERO","MARZO","ABRIL","MAYO","SEPTIEMBRE","OCTUBRE","NOVIEMBRE","DICIEMBRE")) %>% mutate(Mes= as.factor(Mes))

#Por último representamos las calles que menos han molestado a los vecinos en los meses de no verano.
MinMol =ggplot(MinMolNoVe, aes(Mes, MinRuido, color = Calles, size=MinRuido)) + geom_point(shape = 2, size = 4,)+ ggtitle("Calles con mayor nivel de ruido de media por mes sin verano")+scale_y_continuous(limits = c(20,70),name = "Nivel de ruido") 
MinMol
```

Vemos que,la calle que menos ha molestado a los vecinos en todos los meses que no son verano ha sido la Calle Genral Prim. Por tanto, está será la calle más tranquila para vivir durante un año normal.

PREGUNTA 7

¿Qué calles son las más tranquilas para vivir en cada estación del año?

· *VERANO:*

Suponemos verano como Agosto y Junio ya que nos faltan datos de algunos mes de Julio.
Comenzamos, seleccionando los meses.
```{r}
JUNIO2 = RUZAFA_TIDY %>% group_by(Calles) %>% filter(month(Dia_Medicion) == "6") %>% summarise(MinRuido = mean(Valores)) %>% filter(MinRuido == min(MinRuido))

AGOSTO2 = RUZAFA_TIDY %>% group_by(Calles) %>% filter(month(Dia_Medicion) == "8") %>% summarise(MinRuido = mean(Valores)) %>% filter(MinRuido == min(MinRuido))
```

Y seguimos los mismos pasos que en la pregunta anterior para cada estación del año.
```{r}
#Los unimos y creamos un nuevo data frame
MinMolverano = rbind(JUNIO2,AGOSTO2)
#Añadimos la columna de años y lo convertimos en factor
MinMolverano = MinMolverano %>% mutate(Mes = c("JUNIO","AGOSTO")) %>% mutate(Mes= as.factor(Mes))
MinMolverano =ggplot(MinMolverano, aes(Mes, MinRuido, color = Calles, size=MinRuido)) + geom_point(shape = 8, size = 4,)+ ggtitle("Calles con mayor nivel de ruido de media en verano")+scale_y_continuous(limits = c(20,80),name = "Nivel de ruido") 
MinMolverano
```
Vemos que la calle más tranquila para el verano es General Prim.

· *OTOÑO:*

Suponemos otoño como los meses de Septiembre, Octubre, Noviembre y Diciembre.
```{r}
#Los unimos y creamos un nuevo data frame
MinMolOTOÑO = rbind(SEPTIEMBRE2,OCTUBRE2,NOVIEMBRE2,DICIEMBRE2)
#Añadimos la columna de años y lo convertimos en factor
MinMolOTOÑO = MinMolOTOÑO %>% mutate(Mes = c("SEPTIEMBRE","OCTUBRE","NOVIEMBRE","DICIEMBRE")) %>% mutate(Mes= as.factor(Mes))
MinMolOTOÑO =ggplot(MinMolOTOÑO, aes(Mes, MinRuido, color = Calles, size=MinRuido)) + geom_point(shape = 8, size = 4,)+ ggtitle("Calles con mayor nivel de ruido de media en otoño.")+scale_y_continuous(limits = c(20,80),name = "Nivel de ruido") 
MinMolOTOÑO
```
La calle más tranquila para el otoño es General Prim.

· *INVIERNO:*

Suponemos invierno como los meses de Enero, Febrero y Marzo.
```{r}
MinMolINV = rbind(ENERO2,FEBRERO2,MARZO2)
#Añadimos la columna de años y lo convertimos en factor
MinMolINV = MinMolINV %>% mutate(Mes = c("ENERO","FERBREO","MARZO")) %>% mutate(Mes= as.factor(Mes))
MinMolINV =ggplot(MinMolINV, aes(Mes, MinRuido, color = Calles, size=MinRuido)) + geom_point(shape = 8, size = 4,)+ ggtitle("Calles con mayor nivel de ruido de media en invierno")+scale_y_continuous(limits = c(20,80),name = "Nivel de ruido") 
MinMolINV

```
La calle más tranquila para el invierno es General Prim.

· *PRIMAVERA:*

Suponemos primavera como Abril y Mayo.
```{r}
#Los unimos y creamos un nuevo data frame
MinMolPRIM = rbind(ABRIL2,MAYO2)
#Añadimos la columna de años y lo convertimos en factor
MinMolPRIM = MinMolPRIM %>% mutate(Mes = c("ABRIL","MAYO")) %>% mutate(Mes= as.factor(Mes))
MinMolPRIM =ggplot(MinMolPRIM, aes(Mes, MinRuido, color = Calles, size=MinRuido)) + geom_point(shape = 8, size = 4,)+ ggtitle("Calles con mayor nivel de ruido de media en primavera")+scale_y_continuous(limits = c(20,80),name = "Nivel de ruido") 
MinMolPRIM
```
La calle más tranquila para la primavera es General Prim.

En general y en concordancia con lo estudiado anteriormente, la calle más tranquila para todas las estaciones del año es la Calle General Prim.


PREGUNTA 8

¿Qué día de la semana hubo más ruido por calle?¿Y en general?

```{r}
dias = c("lunes","martes","miercoles","jueves","viernes","sabado","domingo")

ruido_calle <- RUZAFA_TIDY %>%
  mutate(dia = weekdays(Dia_Medicion))%>% # columna con los días de la semana
  mutate(dia = factor(weekdays(Dia_Medicion), ordered = T)) %>%
  select(-Dia_Medicion) %>% # eliminamos columna Dia_Medicion
  group_by(dia,Valores) %>% # agrupamos por dia y valor de ruido
  mutate(valor = mean(Valores)) %>% # columna con la media de valores
  unique() # eliminamos los valores repetidos

# representación por puntos
ggplot(ruido_calle, aes(x = Calles, y = valor, group = dia, color = dia)) + 
  geom_point() + geom_smooth() + 
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Nivel sonoro", 
       subtitle = "Nivel sonoro según el día de la semana y ordenado por las calles.")
```

Con el gráfico que representa el nivel sonoro según el día de la semana ordenado por calles, podemos ver para cada calle, el día y el valor del nivel sonoro.
Para cada día de la semana:
  Lunes - (nada)
  Martes - (nada)
  Miercoles - Vivon Chaflán Cadiz
  Jueves - cadiz 16
  Viernes - Sueca 2
  Sabado - Cadiz 3, Carles Cervera 34, Cuba 3, Doctor Serrano 21, General Prim, Puerto Rico 21, Salvador Abril Chaflán, Sueca 32, Sueca 61, Sueca Esquina Denia
  Domingo - Carles Cervera Chaflán
  
  
Vamos a hacer otra representación para ver los niveles sonoros de cada calle según el día.
Esta vez, separandolo por facetas.

```{r}
datos_semana <- RUZAFA_TIDY %>% 
  mutate(dia = weekdays(Dia_Medicion))%>%
  mutate(dia = factor(weekdays(Dia_Medicion),ordered = T))
  

ggplot(datos_semana, aes(x = dia, y = Valores, color = Calles)) + 
  geom_line(position = "jitter") + 
  scale_color_discrete(labels = c("Calle 1", "Calle 2",  "Calle 3",  "Calle 4",  
                                  "Calle 5",  "Calle 6",  "Calle 7",  "Calle 8",  
                                  "Calle 9",  "Calle 10",  "Calle 11",  "Calle 12",  
                                  "Calle 13",  "Calle 14" )) + 
  facet_wrap(~Calles) + theme(axis.text.x = element_text(angle = 90))

```

De esta manera, aunque no sea una representación muy clara, fijandonos en los picos podemos ver, dependiendo de la calle, que día ha tenido un nivel sonoro mayor. 
Esta representación es muy útil a la hora de ver las variaciones de niveles sonoros a lo largo de los días.

Y se puede ver claramente que en la calle "Carles Cervera Chaflán" hubo un nivel sonoro muy alto el domingo.
Luego podemos ver que en las siguientes calles; "Carles Cervera 34", "General Prim" y "Carles Cervera Chaflán", el nivel sonoro el sabado era muy alto.

Mirando la representación de una forma más general, podemos ver claramente que la calle "Sueca 2" es la que tiene los niveles sonoros más bajos, y la calle "Carles Cervantes Chaflán" la que tiene los niveles sonoros más altos.


Ahora vamos a ver la representación del nivel sonoro durante la semana sin tener en cuenta las calles.
Vamos a utilizar una representación boxplot.

```{r}
ggplot(ruido_calle, aes(x = dia, y = Valores, color = dia)) + 
  #geom_boxplot() +
  geom_col(position = "stack") +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Nivel sonoro según el día de la semana", 
       subtitle = "Nivel sonoro según el día de la semana y ordenado por las calles.")

```

Podemos ver que el día que tiene los niveles sonoros más altos es el sábado.



PREGUNTA 9

Hay que hacer analisis univariante y bivariante

```{r}
#Matriz de covarianza de todos los niveles sonosoros para ver cuales tienen mas relacion entre si

#Usamos pivot wider poner de nuevo en columnas los niveles sonoros y poder ver el nivel de relacion entre  las variables

a = pivot_wider(RUZAFA_TIDY,names_from = "Nivel_Sonoro", values_from = "Valores" )

Datos <- select(a, starts_with("Nivel"))
b = cor(Datos, method="pearson")
data.frame(b)
View(b)
cor(a$Nivel_Sonoro_Noche,a$Nivel_Sonoro_Dia, method = "pearson")
cor(a$Nivel_Sonoro_Tarde, a$Nivel_Sonoro_Dia, method = "pearson")


#Vemso que el continuo tiene mas relacion con los valores de sonido de por el dia, y el que menos por la noche
cor(a$Nivel_Sonoro_Continuo, a$Nivel_Sonoro_Dia, method= "pearson")
cor(a$Nivel_Sonoro_Continuo, a$Nivel_Sonoro_Noche, method= "pearson")
cor(a$Nivel_Sonoro_Continuo, a$Nivel_Sonoro_Tarde, method= "pearson")

library(GGally)
ggcorr(b, palette = "Pastel 2 ", color = 1:5, label = T, method = c("everything", "pearson"))



```

PREGUNTA 10

Analizar los datos faltantes

```{r}

```
<<<<<<< HEAD




=======
>>>>>>> 23675c8b6da8d5e455990d66835ae1bb83411c7c


