---
title: "MiniProyecto"
author: "Sergio Marín Castro // Laura Isabel Montoliu Peris // Beatriz Perello Osborne // Gonzalo Sanchez Muñoz"
date: "11/4/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#LIBRERIAS
library(readr)
library(dplyr)
library(tidyr)
library(stringr)
library(lubridate)
library(ggplot2)
library(paletteer)
#SIGNIFICADO DE LAS VARIABLES --> 
#recvTime : Fecha en la que se inserto el dato en la plataforma
#FiwareServicePath : Servicio al que pertenece el sensor
#EntityType : Tipo de sensor
#EntityId : Identificador único del sensor
#LAeq : En este caso el período establecida para este sensor es de 1 minuto
#LAeq_d: Es un indicador de ruido durante el dia desde las 7 hasta las 19 horas.(12h)
#LAeq_den: Indice de ruido día-tarde-noche, para determinar la molestia vinculada a la exposición al ruido.
#LAeq_e: Es un indicador del nivel sonoro durante la tarde desde las 19 hasta las 23 horas.(4h)
#LAeq_n: Es un indicador del nivel sonoro durante la noche desde las 23 hasta las 7 horas.(8h)
#Dateobserved: Día al que se refieren las medidas.
```

# Paso 4

Este paso consiste en importar y fusionar todos los datos en un solo dataframe ("RUZAFA"), además debemos realizar una exploración inicial de los datos.

```{r}
#IMPORTAR FICHEROS
VivChafCadz <- read_csv("data/ VivonsChaflánCádiz.csv", show_col_types = FALSE)
Cadiz3 <- read_csv("data/Cadiz3.csv", show_col_types = FALSE)
Cadiz16 <- read_csv("data/Cadiz16.csv", show_col_types = FALSE)
CarlCerv34 <- read_csv("data/CarlesCervera34.csv", show_col_types = FALSE)
CarlCervChaf <- read_csv("data/CarlesCervera Chaflán.csv", show_col_types = FALSE)
Cuba3 <- read_csv("data/Cuba3.csv", show_col_types = FALSE)
DoctorSerrano21 <- read_csv("data/DoctorSerrano21.csv", show_col_types = FALSE)
GeneralPrim <- read_csv("data/GeneralPrim.csv", show_col_types = FALSE)
PuertoRico21 <- read_csv("data/PuertoRico21.csv", show_col_types = FALSE)
SalvAbrilChaf <- read_csv("data/SalvadorAbrilChaflán.csv", show_col_types = FALSE)
Sueca2 <- read_csv("data/Sueca2.csv", show_col_types = FALSE)
Sueca32 <- read_csv("data/Sueca32.csv", show_col_types = FALSE)
Sueca61 <- read_csv("data/Sueca61.csv", show_col_types = FALSE)
SuecaEsqDenia <- read_csv("data/SuecaEsqDenia.csv", show_col_types = FALSE)
```

```{r}
#UNION DE FICHEROS
RUZAFA <- VivChafCadz %>% full_join(Cadiz3) %>%full_join(Cadiz16) %>%full_join(CarlCervChaf) %>% full_join(CarlCerv34) %>% full_join(Cuba3) %>% full_join(DoctorSerrano21) %>% full_join(GeneralPrim)  %>% full_join(PuertoRico21) %>% full_join(SalvAbrilChaf)%>% full_join(Sueca2 )%>% full_join(Sueca32) %>% full_join(Sueca61) %>% full_join(SuecaEsqDenia)
View(RUZAFA)

```

```{r}
#EXPLORACION INICIAL DE LOS DATOS
dim(RUZAFA)
names(RUZAFA)
summary(RUZAFA)
str(RUZAFA)
attach(RUZAFA)
# Los datos se han reocgido desde 2020-09-17 hasta 2022-04-10
max(dateObserved)
min(dateObserved)
#EL año 2021 esta cmpleto en los otros dos hay muchos menos dias
RUZAFA%>%
  group_by(Año = year(dateObserved))%>%summarise(min= min(dateObserved) ,max=    
  max(dateObserved))
#solo hay un tipo de sensor y servicio al que pertencen. 
table(entityType)
table(fiwareServicePath)
#Algunas calles tienen mas datos de sonoridad que otras y una no tiene datos para 2022
table(entityId)
ggplot(RUZAFA, aes(entityId, fill =factor(year(dateObserved)))) + geom_bar() +theme(axis.text.x = element_text(angle = 90, hjust = 1))+labs(x="Calles",y = "dias", title="Dias de estudio por calle") + guides(fill = guide_legend(title = "Años"))
detach(RUZAFA)

#
```

Posibles preguntas que se pueden plantear y se pueden resolver con los datos proporcionados.

- PREGUNTAS:
HILO DE LA PRESENTACION-->
Un señor que no esta seguro si comprarse una casa en Ruzafa y que tampoco sabe cual seria la mejor calle para vivir, nos ha planteado las siguientes preguntas:

1.¿Cual es la calle que mas ha molestado a los vecinos en en los tres ultimos años?¿Y la que menos?(Laura)
2.¿En que calle ha incrementado mas el ruido a lo largo del año 2022? (Laura)
3.¿La sonoridad en Ruzafa ha ido aumentado o disminuyendo a lo largo del tiempo?
4.¿El covid afectó en algo? ¿Y las fallas? ¿Y la Navidad?
5.¿Que calles han sido las mas ruidosas durante el dia, la tarde, y la noche? ¿Y las que menos?
6.¿Suele haber mas silencio por la tarde o durante el dia en Ruzafa?
7.¿En que mes ha habido mas acumulación de ruido en Ruzafa en cada año?
8.¿Que calles son las mas tranquilas para vivir en cada estacion de año?
9.¿En que calle hay mas ruido los fines de semana en 2022? ¿Hay alguna relacion con la mas ruidosa por la noche?
10.¿En que dia de la semana ha habido mas ruido por calle?¿Y en general?
11. Hay que hacer analisis univariante y bivariante
12. Analizar los datos faltantes

RESPUESTA:
En conclusion la calle que le recomendamos mas para vivir es: .... y la que menos es: .....

# Paso 5

Para obtener un tidy dataset, es decir, un dataframe más representativo y claro, vamos a modificar los nombres de las columnas por unos más adecuados.

```{r}
# Modificamos nombres de columnas
colnames(RUZAFA) # miramos los nombres que tiene el dataframe
colnames(RUZAFA) <- c("Id", "Fecha_Registro", "Servicio_Sensor", "Tipo_Entidad_Sensor", "Id_Sensor",
                      "Nivel_Sonoro_Continuo", "Nivel_Sonoro_Dia", "Nivel_Sonoro_dtn", # dtn - dia, tarde y noche
                      "Nivel_Sonoro_Tarde", "Nivel_Sonoro_Noche", "Dia_Medicion", "Nombre_Calle")

#Ahora eliminamos las columnas que no nos interesan
RUZAFA1 <- RUZAFA %>% select(-Servicio_Sensor, -Tipo_Entidad_Sensor) 

#Para que sea un conjunto tidy debe de haber una variable por cada columna, en este caso los niveles sonoros estan en varias columnas
RUZAFA_TIDY2 <- RUZAFA1 %>% gather(Nivel_Sonoro, Valores, 4:8)

#Ahora vemos si hay datos faltantes o incorrectos y los sustituimos
#Se puede ver que hay dos valores "Inf" y los sustituiremos por los valores mas frecuentes(media)
breaks <- c(min(RUZAFA_TIDY2$Valores), 0, 5, max(RUZAFA_TIDY2$Valores))
ggplot(RUZAFA_TIDY2, aes(Valores)) + geom_histogram(bins=30)
RUZAFA_TIDY2 %>% count(Valores)
RUZAFA_TIDY2 %>% filter(Valores != "Inf") %>% summarise(Media = mean(Valores))#Media 60.4
RUZAFA_TIDY <- RUZAFA_TIDY2 %>% mutate(Valores = ifelse(Valores ==  "Inf", 60.4, Valores)) %>% mutate(Nivel_Sonoro = as.factor(Nivel_Sonoro)) #y convertimos la columna Nivel_Sonoro en factores .
View(RUZAFA_TIDY)


#Por ultimo separamos la columna Fecha Registro, ya que tiene dos variables una de fecha y otra de tiempo
RUZAFA_TIDY = RUZAFA_TIDY %>%
              separate(Fecha_Registro, into=c("Fecha_Registro","Hora_Registro"), sep=10) %>% mutate(Fecha_Registro = as.Date(Fecha_Registro))
str(RUZAFA_TIDY)

#No es tidy pero tambien añadimos la columna calles para que sea mas facil de entender los resultados
#Seleccionamos la columna de Id_sensor
Id_Sensor = RUZAFA_TIDY %>% select(Id_Sensor)

#Creamos la columna Calles
RUZAFA_TIDY = RUZAFA_TIDY %>% mutate(Id_Sensor = ifelse(Id_Sensor == "T248655-daily", "Cadiz3 ", Id_Sensor)) %>% mutate(Id_Sensor = ifelse(Id_Sensor == "T248677-daily" , "VivChafCadz", Id_Sensor))  %>% mutate(Id_Sensor = ifelse(Id_Sensor == "T248671-daily" , " Cadiz16 ", Id_Sensor))  %>% mutate(Id_Sensor = ifelse(Id_Sensor == "T248670-daily" , "CarlCervChaf", Id_Sensor))  %>% mutate(Id_Sensor = ifelse(Id_Sensor == "T248678-daily" , "CarlCerv34 ", Id_Sensor)) %>% mutate(Id_Sensor = ifelse(Id_Sensor == "T248682-daily" , "Cuba3", Id_Sensor)) %>% mutate(Id_Sensor = ifelse(Id_Sensor == "T248669-daily" , "DoctorSerrano21", Id_Sensor))  %>% mutate(Id_Sensor = ifelse(Id_Sensor == "T248682-daily" , "Cuba3", Id_Sensor)) %>% mutate(Id_Sensor = ifelse(Id_Sensor == "T248672-daily" , "PuertoRico21", Id_Sensor))  %>% mutate(Id_Sensor = ifelse(Id_Sensor == "T248676-daily" , "SalvAbrilChaf", Id_Sensor))  %>% mutate(Id_Sensor = ifelse(Id_Sensor == "T248683-daily", "Sueca2" , Id_Sensor)) %>% mutate(Id_Sensor = ifelse(Id_Sensor == "T248680-daily" , "Sueca32", Id_Sensor))  %>% mutate(Id_Sensor = ifelse(Id_Sensor == "T248684-daily","Sueca61", Id_Sensor)) %>% mutate(Id_Sensor = ifelse(Id_Sensor == "T248652-daily","SuecaEsqDenia",  Id_Sensor))  %>% mutate(Id_Sensor = ifelse(Id_Sensor == "T248661-daily" , "GeneralPrim",  Id_Sensor))  
colnames(RUZAFA_TIDY) <- c("Id", "Fecha_Registro", "Hora_Registro", "Calles", "Dia_Medicion", "Nivel_Sonoro", "Valores")
#Ahora se une el data frame con las calles y el dat frame con Id_Sensores
RUZAFA_TIDY = cbind(RUZAFA_TIDY, Id_Sensor)

#Por ultimo ordenamos de nuevo las columnas
RUZAFA_TIDY = RUZAFA_TIDY [ , c(1,8,2,3,4,6,7,5)]
```

PUNTO 6

PREGUNTA 1
```{r}
<<<<<<< HEAD
#1.¿Cuál es la calle que más ha molestado a los vecinos en en los tres ultimos años?¿Y la que menos?

######################################  LA QUE MAS  #######################################

#Seleccionamos la calle con más ruido de cada año
=======

#1.¿Cual es la calle que mas ha molestado a los vecinos en en los tres ultimos años?¿Y la que menos?

######################################  LA QUE MAS  #######################################

#Seleccionamos la calle con mas ruido de cada año
>>>>>>> 23675c8b6da8d5e455990d66835ae1bb83411c7c
Año2020 = RUZAFA_TIDY %>% group_by(Calles) %>% filter(year(Dia_Medicion) == "2020") %>% summarise(MaxRuido = mean(Valores)) %>% filter(MaxRuido == max(MaxRuido))

Año2021 = RUZAFA_TIDY %>% group_by(Calles) %>% filter(year(Dia_Medicion) == "2021") %>% summarise(MaxRuido = mean(Valores)) %>% filter(MaxRuido == max(MaxRuido))

Año2022 =  RUZAFA_TIDY %>% group_by(Calles) %>% filter(year(Dia_Medicion) == "2022") %>% summarise(MaxRuido = mean(Valores)) %>% filter(MaxRuido == max(MaxRuido))

#Los unimos y creamos un nuevo data frame
MaxMolestia = rbind(Año2020, Año2021, Año2022)
#Añadimos la columna de años y lo convertimos en factor
MaxMolestia = MaxMolestia %>% mutate(Año = c(2020, 2021, 2022)) %>% mutate(Año = as.factor(Año))
MaxMolestia

#Por ultimo representamos las calles que mas han molestado a los vecinos en los ultimos 3 años
a =ggplot(MaxMolestia, aes(Año, MaxRuido, color = Calles, size = MaxRuido)) + geom_point(shape = 3, size=5) + ggtitle("Calles con mayor nivel de ruido de media por año")+scale_y_continuous(limits = c(53,67),name = "Nivel de ruido") 
a
#En conclusion podemos ver que la calle que más ha molestado a los vecinos en 2020, 2021 y 2022 es la misma, Cadiz3

#######################################  LA QUE MENOS   ###################################

Año2020 = RUZAFA_TIDY%>% group_by(Calles) %>% filter(year(Dia_Medicion) == "2020") %>% summarise(MinRuido = mean(Valores)) %>% filter(MinRuido == min(MinRuido))

Año2021 = RUZAFA_TIDY%>% group_by(Calles) %>% filter(year(Dia_Medicion) == "2021") %>% summarise(MinRuido = mean(Valores)) %>% filter(MinRuido == min(MinRuido))

Año2022 =  RUZAFA_TIDY%>% group_by(Calles) %>% filter(year(Dia_Medicion) == "2022") %>% summarise(MinRuido = mean(Valores)) %>% filter(MinRuido == min(MinRuido))

#Los unimos y creamos un nuevo data frame
MinMolestia = rbind(Año2020, Año2021, Año2022)
#Añadimos la columna de años y lo convertimos en factor
MinMolestia = MinMolestia %>% mutate(Año = c(2020, 2021, 2022)) %>% mutate(Año = as.factor(Año))

#Por ultimo representamos las calles que mas han molestado a los vecinos en los ultimos 3 años
b =ggplot(MinMolestia, aes(Año, MinRuido, color = Calles, size=MinRuido)) + geom_point(shape = 10, size = 5)+ ggtitle("Calles con menor nivel de ruido de media por año")+scale_y_continuous(limits = c(53,67),name = "Nivel de ruido") 
b
#En conclusion podemos ver que la calle que menos ha molestado a los vecinos en 2020, 2021 y 2022 es la misma, GeneralPrim

```

PREGUNTA 2

```{r}
#2.¿En que calle ha incrementado mas el ruido a lo largo del año 2022?
RUZAFA_TIDY2 = RUZAFA_TIDY %>% filter(year(Dia_Medicion) == "2022") %>% group_by(Calles)
RUZAFA_TIDY2 = RUZAFA_TIDY2%>%
              select(Calles, Valores, Dia_Medicion)
ggplot(RUZAFA_TIDY2, aes(Dia_Medicion, Valores)) + geom_line() + facet_wrap(~Calles)+geom_smooth(method = 'lm')

#SOLUCION: Se puede ver que el nivel Sonoro de cada calle a lo largo de 2022 (enero-marzo) no varía notablemente excepto en el mes de marzo que en todas las calles el nivel aumenta.

```

PREGUNTA 3
```{r}
#3.¿La sonoridad en Ruzafa ha ido aumentado o disminuyendo a lo largo del tiempo?
#¿El covid afectó en algo? ¿Y las fallas? ¿Y la Navidad?
RUZAFA_TIDY3_1 = RUZAFA_TIDY %>% select(Dia_Medicion, Calles, Valores) %>% group_by(year(Dia_Medicion)) %>% filter(year(Dia_Medicion) == "2020")
ggplot(RUZAFA_TIDY3_1, aes(Dia_Medicion, Valores, color = month(Dia_Medicion)))+ geom_line() + geom_smooth(color="darkgrey")

RUZAFA_TIDY3_2 = RUZAFA_TIDY %>% select(Dia_Medicion, Calles, Valores) %>% group_by(year(Dia_Medicion)) %>% filter(year(Dia_Medicion) == "2021")
ggplot(RUZAFA_TIDY3_2, aes(Dia_Medicion, Valores, color = month(Dia_Medicion)))+ geom_line() + scale_y_continuous(limits=c(40,100)) + geom_smooth(color="darkgrey")

RUZAFA_TIDY3_3 = RUZAFA_TIDY %>% select(Dia_Medicion, Calles, Valores) %>% group_by(year(Dia_Medicion)) %>% filter(year(Dia_Medicion) == "2022")

ggplot(RUZAFA_TIDY3_3, aes(Dia_Medicion, Valores, color = month(Dia_Medicion)))+ geom_line() + scale_y_continuous(limits=c(40,100)) + geom_smooth(color="darkgrey")


```

```{r}
#POR LA NOCHE TODAS LAS CALLES NE UN GRAFICO
#Relacionar luego max ruido con max noche
dat = RUZAFA_TIDY %>% filter(Nivel_Sonoro == "Nivel_Sonoro_Noche") 

#COLS = c("gray", "pink", "blue", "#5CB85C", "yellow", "orange", "purple", "black", "turquese", "brown", "green", "red", )
ggplot(dat, aes(x = Dia_Medicion, y = Valores, color = Calles)) + geom_line(position = "jitter") + scale_color_discrete(labels = c("Calle 1", "Calle 2",  "Calle 3",  "Calle 4",  "Calle 5",  "Calle 6",  "Calle 7",  "Calle 8",  "Calle 9",  "Calle 10",  "Calle 11",  "Calle 12",  "Calle 13",  "Calle 14" )) + facet_wrap(~Calles)

ggplot(dat, aes(x = Dia_Medicion, y = Valores, color = Calles)) + geom_line(position = "jitter") + scale_color_discrete(labels = c("Calle 1", "Calle 2",  "Calle 3",  "Calle 4",  "Calle 5",  "Calle 6",  "Calle 7",  "Calle 8",  "Calle 9",  "Calle 10",  "Calle 11",  "Calle 12",  "Calle 13",  "Calle 14" )) 

dat= dat%>%group_by(Calles, Mes = month(Dia_Medicion)) %>% summarise(Max = max(Valores)) %>% mutate(Mes = ifelse(Mes == 1, "enero",Mes)) %>% mutate(Mes = ifelse(Mes == 2, "febrero",Mes)) %>% mutate(Mes = ifelse(Mes == 3, "marzo",Mes)) %>% mutate(Mes = ifelse(Mes == 4, "abril",Mes)) %>% mutate(Mes = ifelse(Mes == 5, "mayo",Mes)) %>% mutate(Mes = ifelse(Mes == 6, "junio",Mes)) %>% mutate(Mes = ifelse(Mes == 7, "julio",Mes)) %>% mutate(Mes = ifelse(Mes == 8, "agosto",Mes)) %>% mutate(Mes = ifelse(Mes == 9, "septiembre",Mes)) %>% mutate(Mes = ifelse(Mes == 10, "octubre",Mes)) %>% mutate(Mes = ifelse(Mes == 11, "noviembre",Mes)) %>% mutate(Mes = ifelse(Mes == 12, "diciembre",Mes))
dat


 

```


PREGUNTA 4
```{r}
#4.¿Que calles han sido las mas ruidosas durante el dia, la tarde, y la noche? ¿Y las que menos?


```

PREGUNTA 5
```{r}
#5.¿Suele haber mas silencio por la tarde o durante el dia en Ruzafa?

```

PREGUNTA 6
```{r}
<<<<<<< HEAD
#6.#¿Cuál es la calle que más MOLESTÓ a los vecinos en los meses de verano de los dos últimos años?¿Y la que menos?

RUZAFA_TIDY$level=factor(RUZAFA_TIDY$Valores, levels=c("Very Low", "Low", "Medium", "Loud", "Very Loud"))
nr1=RUZAFA_TIDY %>% ggplot(aes(Valores,..count..*100/sum(..count..), fill=Valores))+
  geom_bar()+
  scale_y_continuous(limits = c(0,100))+
  labs(y="Porcentaje por nivel de sonido")
nr2=RUZAFA_TIDY %>% ggplot(aes(Street, fill=Valores))+
  geom_bar(position="dodge")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.position="none")
layout=matrix(c(1,3,2,3),2,2, byrow=T)
multiplot(nr1, nr2, layout=layout)

#Suponemos meses de verano como: Junio, Julio y Agosto.

JUNIO2020 = RUZAFA_TIDY %>% group_by(Calles) %>% filter(year(Dia_Medicion) == "2020") %>% filter(month(Dia_Medicion) == "02") %>% summarise(MaxRuido = mean(Valores)) %>% filter(MaxRuido == max(MaxRuido))

JULIO2020 = RUZAFA_TIDY %>% group_by(Calles) %>% filter(month(Dia_Medicion) == "07") %>% summarise(MaxRuido = mean(Valores)) %>% filter(MaxRuido == max(MaxRuido))

AGOSTO2020 = RUZAFA_TIDY %>% group_by(Calles) %>% filter(year(Dia_Medicion) == "2020") %>% filter(month(Dia_Medicion) == "08") %>% summarise(MaxRuido = mean(Valores)) %>% filter(MaxRuido == max(MaxRuido))

JUNIO2021 = RUZAFA_TIDY %>% group_by(Calles) %>% filter(year(Dia_Medicion) == "2021") %>% filter(month(Dia_Medicion) == "06") %>% summarise(MaxRuido = mean(Valores)) %>% filter(MaxRuido == max(MaxRuido))

JULIO2021 = RUZAFA_TIDY %>% group_by(Calles) %>% filter(year(Dia_Medicion) == "2021") %>% filter(month(Dia_Medicion) == "07") %>% summarise(MaxRuido = mean(Valores)) %>% filter(MaxRuido == max(MaxRuido))

AGOSTO2021 = RUZAFA_TIDY %>% group_by(Calles) %>% filter(year(Dia_Medicion) == "2021") %>% filter(month(Dia_Medicion) == "08") %>% summarise(MaxRuido = mean(Valores)) %>% filter(MaxRuido == max(MaxRuido))

#Creamos un nuevo df con los datos obtenidos para poder analizarlo mejor.
MolestiaVerano = rbind(JUNIO2020, JUNIO2021, JULIO2020, JULIO2021, AGOSTO2020, AGOSTO2021)


=======
#6.¿En que mes ha habido mas acumulación de ruido en Ruzafa en cada año?
 
>>>>>>> 23675c8b6da8d5e455990d66835ae1bb83411c7c
```


PREGUNTA 7
```{r}
#7.¿Que calles son las mas tranquilas para vivir en cada estacion de año?
#Relacion pearson de marzo 2022 y 2021 y diciembre 2020 y 2021



```


PREGUNTA 8
```{r}
#8.¿En que calle hay mas ruido los fines de semana en 2022? ¿Hay alguna relacion con la mas ruidosa por la noche?

```


PREGUNTA 9
```{r}
#9.¿En que dia de la semana ha habido mas ruido por calle?¿Y en general?

```

PREGUNTA 10
```{r}
#10.¿En que dia de la semana ha habido mas ruido por calle?¿Y en general?


```

PREGUNTA 11

```{r}

#11. Hayq ue hacer analisis univariante y bivariante


```

PREGUNTA 12
```{r}
#12. Analizar los datos faltantes

```
<<<<<<< HEAD




=======
>>>>>>> 23675c8b6da8d5e455990d66835ae1bb83411c7c

