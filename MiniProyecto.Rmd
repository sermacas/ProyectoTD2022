---
title: "MiniProyecto"
author: "Sergio Marín Castro // Laura Isabel Montoliu Peris // Beatriz Perello Osborne // Gonzalo Sanchez Muñoz"
date: "11/4/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#LIBRERIAS
library(readr)
library(dplyr)
library(tidyr)
library(stringr)
library(lubridate)
library(ggplot2)
#SIGNIFICADO DE LAS VARIABLES --> 
#recvTime : Fecha en la que se inserto el dato en la plataforma
#FiwareServicePath : Servicio al que pertenece el sensor
#EntityType : Tipo de sensor
#EntityId : Identificador único del sensor
#LAeq : En este caso el período establecida para este sensor es de 1 minuto
#LAeq_d: Es un indicador de ruido durante el dia desde las 7 hasta las 19 horas.(12h)
#LAeq_den: Indice de ruido día-tarde-noche, para determinar la molestia vinculada a la exposición al ruido.
#LAeq_e: Es un indicador del nivel sonoro durante la tarde desde las 19 hasta las 23 horas.(4h)
#LAeq_n: Es un indicador del nivel sonoro durante la noche desde las 23 hasta las 7 horas.(8h)
#Dateobserved: Día al que se refieren las medidas.
```

# Paso 4

Este paso consiste en importar y fusionar todos los datos en un solo dataframe ("RUZAFA"), además debemos realizar una exploración inicial de los datos.

```{r}
#IMPORTAR FICHEROS
VivChafCadz <- read_csv("data/ VivonsChaflánCádiz.csv", show_col_types = FALSE)
Cadiz3 <- read_csv("data/Cadiz3.csv", show_col_types = FALSE)
Cadiz16 <- read_csv("data/Cadiz16.csv", show_col_types = FALSE)
CarlCerv34 <- read_csv("data/CarlesCervera34.csv", show_col_types = FALSE)
CarlCervChaf <- read_csv("data/CarlesCervera Chaflán.csv", show_col_types = FALSE)
Cuba3 <- read_csv("data/Cuba3.csv", show_col_types = FALSE)
DoctorSerrano21 <- read_csv("data/DoctorSerrano21.csv", show_col_types = FALSE)
GeneralPrim <- read_csv("data/GeneralPrim.csv", show_col_types = FALSE)
PuertoRico21 <- read_csv("data/PuertoRico21.csv", show_col_types = FALSE)
SalvAbrilChaf <- read_csv("data/SalvadorAbrilChaflán.csv", show_col_types = FALSE)
Sueca2 <- read_csv("data/Sueca2.csv", show_col_types = FALSE)
Sueca32 <- read_csv("data/Sueca32.csv", show_col_types = FALSE)
Sueca61 <- read_csv("data/Sueca61.csv", show_col_types = FALSE)
SuecaEsqDenia <- read_csv("data/SuecaEsqDenia.csv", show_col_types = FALSE)
```

```{r}
#UNION DE FICHEROS
RUZAFA <- VivChafCadz %>% full_join(Cadiz3) %>%full_join(Cadiz16) %>%full_join(CarlCervChaf) %>% full_join(CarlCerv34) %>% full_join(Cuba3) %>% full_join(DoctorSerrano21) %>% full_join(GeneralPrim)  %>% full_join(PuertoRico21) %>% full_join(SalvAbrilChaf)%>% full_join(Sueca2 )%>% full_join(Sueca32) %>% full_join(Sueca61) %>% full_join(SuecaEsqDenia)
View(RUZAFA)

```

```{r}
#EXPLORACION INICIAL DE LOS DATOS
dim(RUZAFA)
names(RUZAFA)
summary(RUZAFA)
str(RUZAFA)
attach(RUZAFA)
# Los datos se han reocgido desde 2020-09-17 hasta 2022-04-10
max(dateObserved)
min(dateObserved)
#EL año 2021 esta cmpleto en los otros dos hay muchos menos dias
RUZAFA%>%
  group_by(Año = year(dateObserved))%>%summarise(min= min(dateObserved) ,max=    
  max(dateObserved))
#solo hay un tipo de sensor y servicio al que pertencen. 
table(entityType)
table(fiwareServicePath)
#Algunas calles tienen mas datos de sonoridad que otras y una no tiene datos para 2022
table(entityId)
ggplot(RUZAFA, aes(entityId, fill =factor(year(dateObserved)))) + geom_bar() +theme(axis.text.x = element_text(angle = 90, hjust = 1))+labs(x="Calles",y = "dias", title="Dias de estudio por calle") + guides(fill = guide_legend(title = "Años"))
detach(RUZAFA)
#
```

Posibles preguntas que se pueden plantear y se pueden resolver con los datos proporcionados.

- PREGUNTAS:
HILO DE LA PRESENTACION-->
Un señor que no esta seguro si comprarse una casa en Ruzafa y que tampoco sabe cual seria la mejor calle para vivir, nos ha planteado las siguientes preguntas:

1.¿Cual es la calle que mas ha molestado a los vecinos en en los tres ultimos años?¿Y la que menos?
2.¿En que calle ha incrementado mas el ruido a lo largo del año 2022?
3.¿La sonoridad en Ruzafa ha ido aumentado o disminuyendo a lo largo del tiempo?
4.¿Que año ha sido el más tranquilo?
5.¿El covid afectó en algo? ¿Y las fallas? ¿Y la Navidad?
6.¿Que calles han sido las mas ruidosas durante el dia, la tarde, y la noche? ¿Y las que menos?
7.¿Suele haber mas silencio por la tarde o durante el dia en Ruzafa?
8.¿En que mes ha habido mas acumulación de ruido en Ruzafa en cada año?
9.¿Que calles son las mas tranquilas para vivir en cada estacion de año?
10.¿En que calle hay mas ruido los fines de semana en 2022? ¿Hay alguna relacion con la mas ruidosa por la noche?
11.¿En que dia de la semana ha habido mas ruido por calle?¿Y en general?

RESPUESTA:
En conclusion la calle que le recomendamos mas para vivir es: .... y la que menos es: .....

# Paso 5

Para obtener un tidy dataset, es decir, un dataframe más representativo y claro, vamos a modificar los nombres de las columnas por unos más adecuados.

```{r}
# Modificamos nombres de columnas
colnames(RUZAFA) # miramos los nombres que tiene el dataframe
colnames(RUZAFA) <- c("Id", "Fecha_Registro", "Servicio_Sensor", "Tipo_Entidad_Sensor", "Id_Sensor",
                      "Nivel_Sonoro_Continuo", "Nivel_Sonoro_Dia", "Nivel_Sonoro_dtn", # dtn - dia, tarde y noche
                      "Nivel_Sonoro_Tarde", "Nivel_Sonoro_Noche", "Dia_Medicion", "Nombre_Calle")

#Ahora eliminamos las columnas que no nos interesan
RUZAFA1 <- RUZAFA %>% select(-Servicio_Sensor, -Tipo_Entidad_Sensor) 

#Para que sea un conjunto tidy debe de haber una variable por cada columna, en este caso los niveles sonoros estan en varias columnas
RUZAFA_TIDY2 <- RUZAFA1 %>% gather(Nivel_Sonoro, Valores, 4:8)

#Ahora vemos si hay datos faltantes o incorrectos y los sustituimos
#Se puede ver que hay dos valores "Inf" y los sustituiremos por los valores mas frecuentes(media)
breaks <- c(min(RUZAFA_TIDY2$Valores), 0, 5, max(RUZAFA_TIDY2$Valores))
ggplot(RUZAFA_TIDY2, aes(Valores)) + geom_histogram(bins=30)
RUZAFA_TIDY2 %>% count(Valores)
RUZAFA_TIDY2 %>% filter(Valores != "Inf") %>% summarise(Media = mean(Valores))#Media 60.4
RUZAFA_TIDY <- RUZAFA_TIDY2 %>% mutate(Valores = ifelse(Valores ==  "Inf", 60.4, Valores)) %>% mutate(Nivel_Sonoro = as.factor(Nivel_Sonoro)) #y convertimos la columna Nivel_Sonoro en factores .
View(RUZAFA_TIDY)

#Por ultimo separamos la columna Fecha Registro, ya que tiene dos variables una de fecha y otra de tiempo
RUZAFA_TIDY = RUZAFA_TIDY %>%
              separate(Fecha_Registro, into=c("Fecha_Registro","Hora_Registro"), sep=10) %>% mutate(Fecha_Registro = as.Date(Fecha_Registro))
str(RUZAFA_TIDY)
```

PUNTO 6

```{r}
#PREGUNTA 1
#1.¿Cual es la calle que mas ha molestado a los vecinos en en los tres ultimos años?¿Y la que menos?

 
#Seleccionamos la calle con mas ruido de cada año
Año2020 = RUZAFA_TIDY%>% group_by(Id_Sensor) %>% filter(year(Dia_Medicion) == "2020") %>% summarise(MaxRuido = max(Valores)) %>% filter(MaxRuido == max(MaxRuido))

Año2021 = RUZAFA_TIDY%>% group_by(Id_Sensor) %>% filter(year(Dia_Medicion) == "2021") %>% summarise(MaxRuido = max(Valores)) %>% filter(MaxRuido == max(MaxRuido))

Año2022 =  RUZAFA_TIDY%>% group_by(Id_Sensor) %>% filter(year(Dia_Medicion) == "2022") %>% summarise(MaxRuido = max(Valores)) %>% filter(MaxRuido == max(MaxRuido))

#Los unimos y creamos un nuevo data frame
MaxMolestia = rbind(Año2020, Año2021, Año2022)

#Añadimos la columna de años y lo convertimos en factor
MaxMolestia = MaxMolestia %>% mutate(Año = c(2020, 2021, 2022))%>% mutate(Año = as.factor(Año))

#Les damos nombres a los Id_Sonoro segun a la calle a la que pertenezcan
MaxMolestia = MaxMolestia %>% mutate(Id_Sensor = ifelse(Id_Sensor == "T248676-daily", "SalvAbrilChaf ", Id_Sensor)) %>% mutate(Id_Sensor = ifelse(Id_Sensor == "T248670-daily", "CarlCervChaf", Id_Sensor)) %>% mutate(Id_Sensor = ifelse(Id_Sensor == "T248680-daily", "Sueca32", Id_Sensor)) 

#Renombramos la columna transformada de Id_Sonoro a Calles
colnames(MaxMolestia)[1] <- "Calles"
MaxMolestia

#Por ultimo representamos las calles que mas han molestado a los vecinos en los ultimos 3 años
ggplot(MaxMolestia, aes(Año, MaxRuido, color = Calles, size = MaxRuido)) + geom_point()
```








